<!DOCTYPE html>
<html lang="en">
	<head>

		<title>RLC FemaleRigged 2011v2 (alpha 0.4)</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/joystick.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">
		<link rel="stylesheet" href="/css/jcrop.css">

		<script src="/js/watch.js"></script>
		<script src="/js/jquery.min.js"></script> 
		<script src="/js/system.min.js"></script>
		<script src="/js/signals.min.js"></script>
		<script src="/js/inflate.min.js"></script>
		<script src="/js/zangodb.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/hold-event.min.js"></script>
		<script src="/js/jcrop.js"></script>

		<style>


			body {
				margin: 0px;
				font-size: 13px;
				font-family: sans-serif;
				background-repeat: repeat;
				background-image: url("https://i.imgur.com/rnZZU0i.png") !important;
				overflow: hidden;
			}

			#loading-bar {
				width:100%;
				height:100%;
				top:0; left:0;
				position:fixed;
				display:flex;
				align-items:center;
				justify-content:center;
			}

			.middle > * {
				top:0; 
				left:0;
				right:0;
				bottom:0;
				margin:auto;
				position:absolute;
			}

			#joystick1 {
				right: calc(40px + 370px);
			}
			
			#jumpButton {
				right: calc(105px + 370px);
			}

			.btn-matcap,
			.btn-terrain {
				padding:0;
				float:left;
				width:55px;
				height:55px;
				border:1px solid;
				border-radius:4px;
				margin-right:4px;
				margin-bottom:4px;
				display:inline-block;
			}

			.btn-matcap + .btn-matcap,
			.btn-terrain + .btn-terrain {
				margin-right:4px;
			}

		</style>
	</head>

	<body ontouchstart="">

		<script src="/rlc/js/three.js"></script>
		<script src="/rlc/js/TabUI.js"></script>
		<script src="/rlc/js/MeshWalk.js"></script>
		<script src="/rlc/js/UVsDebug.js"></script>
		<script src="/rlc/js/FBXLoader.js"></script>
		<script src="/rlc/js/VirtualInput.js"></script>
		<script src="/rlc/js/EditorControls.js"></script>
		<script src="/rlc/js/SubdivisionModifier.js"></script>
		<script src="/rlc/js/three-pathfinding.umd.js"></script>
		<script src="/threejs/r96/examples/js/loaders/GLTFLoader.js"></script>
		<script src="/threejs/r96/examples/js/exporters/GLTFExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/STLExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/OBJExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/ColladaExporter.js"></script>

		<script>

			var debugMode = true; // important!
			MW.install( THREE ); // important!
		//	THREE.Pathfinding = threePathfinding.Pathfinding;
		//	THREE.PathfindingHelper = threePathfinding.PathfindingHelper;
			Number.prototype.format = function (){
				return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
			};

		</script>

		<script>

		//	TabUI

			(function(){

				var sidePanel = createSidePanel();
				sidePanel.style.background = "#eeeeeeee";

				var skinTab = TabUI.add( "Skin", "skin-tab" );
				var eyesTab = TabUI.add( "Eyes", "eyes-tab" );
				var hairTab = TabUI.add( "Hair", "hair-tab" );
				var shoeTab = TabUI.add( "Shoes", "shoe-tab" );
				var debugTab = TabUI.add( "Debug", "debug-tab" );
				var outfitTab = TabUI.add( "Outfit", "outfit-tab" );
				var materialTab = TabUI.add( "Materials", "material-tab" );
				var snapshotTab = TabUI.add( "Snapshots", "snapshots-tab" );
				var animationTab = TabUI.add( "Animations", "animation-tab" );

			//	var loginTab = TabUI.add( "Login", "login-tab" );
			//	var levelTab = TabUI.add( "Levels", "level-tab" );
			//	var cameraTab = TabUI.add( "Camera", "camera-tab" );
			//	var controlTab = TabUI.add( "Controls", "control-tab" );
			//	var underwearTab = TabUI.add( "Underwears", "underwears-tab" );

				document.body.appendChild( sidePanel );
				TabUI.append("Outfit", "Materials", "Snapshots", "Animations", "Eyes", "Hair", "Skin", "Shoes", "Debug" );
				TabUI.Snapshots.role.classList.add("active");
				TabUI.Snapshots.tab.classList.add("in","active");

			})();

		</script>

		<script>

		//	Outfit tab.

			(function(){

			//	Outfit Manager.

				Signal = signals.Signal;

				OutfitManager = {

					currentSlot: null,
					currentLayer: null,
					update: new Signal(),

					layerDroplistUpdated: new Signal(),
					outfitDroplistUpdated: new Signal(),

					hatDroplistUpdated: new Signal(),
					hairDroplistUpdated: new Signal(),
					shoesDroplistUpdated: new Signal(),
					glassesDroplistUpdated: new Signal(),
					upperbodyDroplistUpdated: new Signal(),
					lowerbodyDroplistUpdated: new Signal(),

				};

				watch( OutfitManager, "currentSlot", function(prop, action, value){
					debugMode && console.log( prop, action, value );
					document.getElementById("outfit-droplist").value = value;
				});

				watch( OutfitManager, "currentLayer", function(prop, action, value){
					debugMode && console.log( prop, action, value );
					document.getElementById("layer-droplist").value = value;
				});

			})();

			(function(){

			//	Layer Slot.

				var layers = {
					skin:      null,
					tattoo:    null,
					makeup:    null,
					clothing:  null,
					overcoat:  null,
					bodypaint: null,
					underwear: null,
				};

				var tab = TabUI.Outfit.tab;
				var row = document.createElement("h3");
				row.textContent = "Layer";

				var select = document.createElement("select");
				select.id = "layer-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				select.appendChild(createOption("Skin"));
				select.appendChild(createOption("Tattoo"));
				select.appendChild(createOption("Makeup"));
				select.appendChild(createOption("Clothing"));
				select.appendChild(createOption("Overcoat"));
				select.appendChild(createOption("Bodypaint"));
				select.appendChild(createOption("Underwear"));

				select.addEventListener( "change", function(){
					OutfitManager.currentLayer = this.value;
				});

				OutfitManager.addLayer = 
				OutfitManager.setLayerValue = function(key, item){
					layers[ key.toLowerCase() ] = item;
				};

				OutfitManager.getLayer = 
				OutfitManager.getLayerValue = function(){
					return layers[ select.value ];
				};

				OutfitManager.getLayers = 
				OutfitManager.getLayerItems = function(){
					return layers;
				};

				select.value = "";
				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					option.value = name.toLowerCase();
					return option;
				}

			})();

			(function(){

			//	Outfit slot.
				
				var slots = {
					hair:  null,
					body:  null,
					legs:  null,
					torso: null,
					shoes: null,
					glasses: null,
				};

				var tab = TabUI.Outfit.tab;
				var row = document.createElement("h3");
				row.textContent = "Outfit";
				row.title = "Outfit manager";

				var select = document.createElement("select");
				select.id = "outfit-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				select.appendChild(createOption("Hair"));
				select.appendChild(createOption("Body"));
				select.appendChild(createOption("Legs"));
				select.appendChild(createOption("Torso"));
				select.appendChild(createOption("Shoes"));
				select.appendChild(createOption("Glasses"));

				select.addEventListener( "change", function(){
					var key = this.value.toLowerCase();
					OutfitManager.currentSlot = key; // important!
					OutfitManager.outfitDroplistUpdated.dispatch( slots[ key ] ); // uuid.
				});

				OutfitManager.add = 
				OutfitManager.addItem = function(key, item){
					slots[ key.toLowerCase() ] = item;
				};

				OutfitManager.getItem = 
				OutfitManager.getSlotValue = 
				OutfitManager.get = function( key ){
					if ( key ) return slots[ key.toLowerCase() ];
					else return slots[ select.value.toLowerCase() ];
				};

				OutfitManager.getItems = 
				OutfitManager.getSlotItems = function(){
					return slots;
				};

				OutfitManager.setValue = 
				OutfitManager.setSlotValue = 
				OutfitManager.set = function( key, value ){
					slots[ key.toLowerCase() ] = value; // uuid.
				};

				OutfitManager.outfitDroplistUpdated.add( function( uuid ){

					var select = document.getElementById("material-droplist");
					if ( !select ) throw "outfitDroplistUpdated: select not found!";

					while ( select.options.length ){ select.options.remove(0); }

					if ( !uuid ) return; // important!
					
					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "outfitDroplistUpdated: mesh not found!";

					if ( Array.isArray(mesh.material) ) 
						mesh.material.forEach(function( material ){
							select.addItem( material );
						});

					else select.addItem( mesh.material );

				});

				select.value = "";
				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					option.value = name.toLowerCase();
					return option;
				}

			})();

		//	Show/Hide button.

			(function(){

				var tab = TabUI.Outfit.tab;
				var row = document.createElement("h3");
				row.style.cssText = "height:40px;";

				var button = document.createElement("div");
				button.style.cssText = "height:40px;font-size:large;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				button.addEventListener( "click", function(){
					var select = document.getElementById("outfit-droplist");
					if ( !select ) throw "outfit-droplist not found!";
					var uuid = OutfitManager.get( select.value );
					var selected = scene.getObjectByProperty( "uuid", uuid );
					if ( !selected ) throw "selected mesh not found!";
					selected.visible = !selected.visible;
					OutfitManager.update.dispatch( selected.visible );
				});

				OutfitManager.update.add( function( visible ){
					button.textContent = "Remove";
					if ( !visible ) button.textContent = "Add";
					if (OutfitManager.currentSlot) {
						button.textContent += " ";
						button.textContent += OutfitManager.currentSlot;
					}
				});

				OutfitManager.update.add( function(){
					var uuid = OutfitManager.getItem("hair"); 
					var select = document.getElementById("hat-droplist");
					var mesh = scene.getObjectByProperty( "uuid", uuid );
					if ( !mesh ) { select.value = ""; return; }
					if ( !mesh.visible ) select.value = ""; else select.value = uuid;
				});

				OutfitManager.update.add( function(){
					var uuid = OutfitManager.getItem("hair"); 
					var select = document.getElementById("hair-droplist");
					var mesh = scene.getObjectByProperty( "uuid", uuid );
					if ( !mesh ) { select.value = ""; return; }
					if ( !mesh.visible ) select.value = ""; else select.value = uuid;
				});

				OutfitManager.update.add( function(){
					var uuid = OutfitManager.getItem("legs"); 
					var select = document.getElementById("lowerbody-droplist");
					var mesh = scene.getObjectByProperty( "uuid", uuid );
					if ( !mesh ) { select.value = ""; return; }
					if ( !mesh.visible ) select.value = ""; else select.value = uuid;
				});

				OutfitManager.update.add( function(){
					var uuid = OutfitManager.getItem("torso"); 
					var select = document.getElementById("upperbody-droplist");
					var mesh = scene.getObjectByProperty( "uuid", uuid );
					if ( !mesh ) { select.value = ""; return; }
					if ( !mesh.visible ) select.value = ""; else select.value = uuid;
				});

				OutfitManager.update.add( function(){
					var uuid = OutfitManager.getItem("shoes"); 
					var select = document.getElementById("shoes-droplist");
					var mesh = scene.getObjectByProperty( "uuid", uuid );
					if ( !mesh ) { select.value = ""; return; }
					if ( !mesh.visible ) select.value = ""; else select.value = uuid;
				});

				OutfitManager.update.add( function(){
					var uuid = OutfitManager.getItem("glasses"); 
					var select = document.getElementById("glasses-droplist");
					var mesh = scene.getObjectByProperty( "uuid", uuid );
					if ( !mesh ) { select.value = ""; return; }
					if ( !mesh.visible ) select.value = ""; else select.value = uuid;
				});

				(function( select ){
					if ( !select ) throw "select not found!";
					select.addEventListener( "change", function(){
						var uuid = OutfitManager.get( select.value );
						if ( !uuid ) {
							OutfitManager.update.dispatch();
							throw "slot "+select.value+" is null!";
						}
						var mesh = scene.getObjectByProperty("uuid", uuid );
						if ( !mesh ) {
							OutfitManager.update.dispatch();
							throw "selected mesh not found!";
						}
						OutfitManager.update.dispatch( mesh.visible );
					});
				})( document.getElementById("outfit-droplist") );

				row.appendChild( button );
				tab.appendChild( row );

			})();

		//	Female Hat.

			(function(){

				var tab = TabUI.Outfit.tab;
				var row = document.createElement("h3");
				row.textContent = "Hat";

				var select = document.createElement("select");
				select.id = "hat-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;";

				select.appendChild(createOption("Ski"));
				select.appendChild(createOption("Witch"));
				select.appendChild(createOption("Nurse"));
				select.appendChild(createOption("Santa"));
				select.appendChild(createOption("Sailor"));
				select.appendChild(createOption("Indian"));
				select.appendChild(createOption("Catwoman"));

				select.addEventListener( "change", function(){
					OutfitManager.currentSlot = "hair"; // important!
					document.getElementById("hair-droplist").value = "";
					OutfitManager.hatDroplistUpdated.dispatch( this.value ); // uuid.
				});

			//	Hide current hair.
				OutfitManager.hatDroplistUpdated.add( function(){
					if ( !OutfitManager.get("hair") ) return; // important!
					var uuid = OutfitManager.get("hair");
					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "hatDroplistUpdated: hair not found!";
					mesh.visible = false; OutfitManager.setValue("hair", null);
				});

			//	Show selected hat.
				OutfitManager.hatDroplistUpdated.add( function( uuid ){

					if ( !uuid ) { 
						OutfitManager.update.dispatch();
						OutfitManager.outfitDroplistUpdated.dispatch( null ); // important!
						return false; // stop propagetion.
					}

					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "hatDroplistUpdated: hat not found!";
					mesh.visible = true; OutfitManager.setValue("hair", uuid);
					OutfitManager.update.dispatch( mesh.visible );
					OutfitManager.outfitDroplistUpdated.dispatch( uuid ); // important!
				});

				select.value = "";
				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					if ( value != null ) option.value = value;
					else option.value = "HF_Hat_"+name.replace(/\s/g, "_");
					return option;
				}

			})();

		//	Female Hair.

			(function(){

				var tab = TabUI.Outfit.tab;
				var Signal = signals.Signal;

				var row = document.createElement("h3");
				row.textContent = "Hair";

				var select = document.createElement("select");
				select.id = "hair-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				select.appendChild(createOption("Med"));
				select.appendChild(createOption("Med Bob"));
				select.appendChild(createOption("Med Shag"));
				select.appendChild(createOption("Med Curly"));
				select.appendChild(createOption("Med Bob Bangs"));
				select.appendChild(createOption("Med Ponytail"));
				select.appendChild(createOption("Bob Tied"));
				select.appendChild(createOption("Bob Short"));
				select.appendChild(createOption("Long Curly"));
				select.appendChild(createOption("Long Parted"));
				select.appendChild(createOption("Long No Bangs"));
				select.appendChild(createOption("Long Cut Bangs"));
				select.appendChild(createOption("Long Straight"));
				select.appendChild(createOption("Long Swoop Bangs"));
				select.appendChild(createOption("Short"));
				select.appendChild(createOption("Short Vic"));
				select.appendChild(createOption("Short Straight"));
				select.appendChild(createOption("Pigtails"));
				select.appendChild(createOption("Piggytail"));
				select.appendChild(createOption("Big Ponytail"));
				select.appendChild(createOption("French Braid"));
				select.appendChild(createOption("Dreads Shoulder"));
				select.appendChild(createOption("Oriental Tied"));
				select.appendChild(createOption("Punk Spike"));
				select.appendChild(createOption("Punk Mohawk"));
				select.appendChild(createOption("Punk Super Spike"));
				select.appendChild(createOption("Punk Mohawk Sides"));
				select.appendChild(createOption("Wavy"));

				select.addEventListener( "change", function(){
					OutfitManager.currentSlot = "hair"; // important!
					document.getElementById("hat-droplist").value = "";
					OutfitManager.hairDroplistUpdated.dispatch( this.value ); // uuid.
				});

			//	Hide current hair.
				OutfitManager.hairDroplistUpdated.add( function(){
					if ( !OutfitManager.get("hair") ) return; // important!
					var uuid = OutfitManager.get("hair");
					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "hatDroplistUpdated: hair not found!";
					mesh.visible = false; OutfitManager.setValue("hair", null);
				});

			//	Show selected hair.
				OutfitManager.hairDroplistUpdated.add( function( uuid ){

					if ( !uuid ) { 
						OutfitManager.update.dispatch();
						OutfitManager.outfitDroplistUpdated.dispatch( null ); // important!
						return false; // stop propagetion.
					}

					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "hatDroplistUpdated: hair not found!";
					mesh.visible = true; OutfitManager.setValue("hair", uuid);
					OutfitManager.update.dispatch( mesh.visible );
					OutfitManager.outfitDroplistUpdated.dispatch( uuid ); // important!
				});

				select.value = "";
				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					if ( value != null ) option.value = value;
					else option.value = "HF_Hair_"+name.replace(/\s/g, "_");
					return option;
				}

			})();

			(function(){

			//	Female Upperbody.

				var tab = TabUI.Outfit.tab;
				var Signal = signals.Signal;

				var row = document.createElement("h3");
				row.textContent = "Torso";

				var select = document.createElement("select");
				select.id = "upperbody-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				select.appendChild(createOption("Dress"));
				select.appendChild(createOption("TShirt"));
				select.appendChild(createOption("Blazer"));
				select.appendChild(createOption("Hoodie"));
				select.appendChild(createOption("Corset"));
				select.appendChild(createOption("Tanktop"));
				select.appendChild(createOption("CowlNeck"));
				select.appendChild(createOption("Long Coat"));
				select.appendChild(createOption("Elvis Jacket"));

				select.addEventListener( "change", function(){
					OutfitManager.currentSlot = "torso"; // important!
					OutfitManager.upperbodyDroplistUpdated.dispatch( this.value ); // uuid.
				});

			//	Hide current upperbody.
				OutfitManager.upperbodyDroplistUpdated.add( function(){
					if ( !OutfitManager.get("torso") ) return; // important!
					var uuid = OutfitManager.get("torso");
					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "upperbodyDroplistUpdated: torso not found!";
					mesh.visible = false; OutfitManager.setValue("torso", null);
				});

			//	Show selected upperbody.
				OutfitManager.upperbodyDroplistUpdated.add( function( uuid ){

					if ( !uuid ) { 
						OutfitManager.update.dispatch();
						OutfitManager.outfitDroplistUpdated.dispatch( null ); // important!
						return false; // stop propagetion.
					}

					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "upperbodyDroplistUpdated: torso not found!";
					mesh.visible = true; OutfitManager.setValue("torso", uuid);
					OutfitManager.update.dispatch( mesh.visible );
					OutfitManager.outfitDroplistUpdated.dispatch( uuid ); // important!
				});

				select.value = "";
				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					if ( value != null ) option.value = value;
					else option.value = "HF_"+name.replace(/\s/g, "_");
					return option;
				}

			})();

			(function(){

			//	Female Lowerbody.

				var tab = TabUI.Outfit.tab;
				var Signal = signals.Signal;

				var row = document.createElement("h3");
				row.textContent = "Legs";

				var select = document.createElement("select");
				select.id = "lowerbody-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				select.appendChild(createOption("Bootcut"));
				select.appendChild(createOption("Baggy Jeans"));
				select.appendChild(createOption("Flare Leg"));
				select.appendChild(createOption("Flare Bottoms"));
				select.appendChild(createOption("Frilly Skirt"));
				select.appendChild(createOption("Mini Skirt"));
				select.appendChild(createOption("Long Skirt"));
				select.appendChild(createOption("Short Skirt"));
				select.appendChild(createOption("Straightleg"));
				select.appendChild(createOption("Gown"));

				select.addEventListener( "change", function(){
					OutfitManager.currentSlot = "legs"; // important!
					OutfitManager.lowerbodyDroplistUpdated.dispatch( this.value ); // uuid.
				});

			//	Hide current lowerbody.
				OutfitManager.lowerbodyDroplistUpdated.add( function(){
					if ( !OutfitManager.get("legs") ) return; // important!
					var uuid = OutfitManager.get("legs");
					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "lowerbodyDroplistUpdated: legs not found!";
					mesh.visible = false; OutfitManager.setValue("legs", null);
				});

			//	Show selected lowerbody.
				OutfitManager.lowerbodyDroplistUpdated.add( function( uuid ){

					if ( !uuid ) { 
						OutfitManager.update.dispatch();
						OutfitManager.outfitDroplistUpdated.dispatch( null ); // important!
						return false; // stop propagetion.
					}

					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "lowerbodyDroplistUpdated: legs not found!";
					mesh.visible = true; OutfitManager.setValue("legs", uuid);
					OutfitManager.update.dispatch( mesh.visible );
					OutfitManager.outfitDroplistUpdated.dispatch( uuid ); // important!
				});

				select.value = "";
				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					if ( value != undefined ) option.value = value;
					else option.value = "HF_"+name.replace(/\s/g, "_");
					return option;
				}

			})();

			(function(){

			//	Female Shoes.

				var tab = TabUI.Outfit.tab;
				var row = document.createElement("h3");
				row.textContent = "Shoes";

				var select = document.createElement("select");
				select.id = "shoes-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;";
				
			//	select.appendChild(createOption("Shoes10"));

				for ( var k = 1; k < 22; k++ ) {
					(function(i){
						var name = "Shoes ";
						var value = "HF_Shoes_";
						if ( i < 10 ) { name += "0"; value += "0"; }
						var option = document.createElement("option");
						name += i; option.text = name; 
						value += i; option.value = value;
						if ( i == 7 ) option.setAttribute("selected", "");
						select.appendChild( option );
					})(k);
				}

				select.addEventListener( "change", function(){
					OutfitManager.currentSlot = "shoes"; // important!
					OutfitManager.shoesDroplistUpdated.dispatch( this.value ); // uuid.
				});

			//	Hide current shoes.
				OutfitManager.shoesDroplistUpdated.add( function(){
					if ( !OutfitManager.get("shoes") ) return; // important!
					var uuid = OutfitManager.get("shoes");
					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "shoesDroplistUpdated: shoes not found!";
					mesh.visible = false; OutfitManager.setValue("shoes", null);
				});

			//	Show selected shoes.
				OutfitManager.shoesDroplistUpdated.add( function( uuid ){

					if ( !uuid ) { 
						OutfitManager.update.dispatch();
						OutfitManager.outfitDroplistUpdated.dispatch( null ); // important!
						return false; // stop propagetion.
					}

					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "shoesDroplistUpdated: shoes not found!";
					mesh.visible = true; OutfitManager.setValue("shoes", uuid);
					OutfitManager.update.dispatch( mesh.visible );
					OutfitManager.outfitDroplistUpdated.dispatch( uuid ); // important!
				});

				select.value = "";
				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					if ( value != undefined ) option.value = value;
					else option.value = "HF_Shoes_"+name.replace(/\s/g, "_");
					return option;
				}

			})();

		//	Female Glasses.

			(function(){

				var tab = TabUI.Outfit.tab;
				var Signal = signals.Signal;

				var row = document.createElement("h3");
				row.textContent = "Glasses";

				var select = document.createElement("select");
				select.id = "glasses-droplist";
				select.style.cssText = "width:180px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				select.appendChild(createOption("Mask"));
				select.appendChild(createOption("Glasses1"));
				select.appendChild(createOption("Glasses2"));
				select.appendChild(createOption("Glasses3"));
				select.appendChild(createOption("Glasses4"));

				select.addEventListener( "change", function(){
					OutfitManager.currentSlot = "glasses"; // important!
					OutfitManager.glassesDroplistUpdated.dispatch( this.value ); // uuid.
				});

			//	Hide current glasses.
				OutfitManager.glassesDroplistUpdated.add( function(){
					if ( !OutfitManager.get("glasses") ) return; // important!
					var uuid = OutfitManager.get("glasses");
					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "glassesDroplistUpdated: glasses not found!";
					mesh.visible = false; OutfitManager.setValue("glasses", null);
				});

			//	Show selected glasses.
				OutfitManager.glassesDroplistUpdated.add( function( uuid ){

					if ( !uuid ) {
						OutfitManager.update.dispatch();
 						OutfitManager.outfitDroplistUpdated.dispatch( null ); // important!
						return false; // stop propagetion.
					}

					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "glassesDroplistUpdated: glasses not found!";
					mesh.visible = true; OutfitManager.setValue("glasses", uuid);
					OutfitManager.update.dispatch( mesh.visible );
					OutfitManager.outfitDroplistUpdated.dispatch( uuid ); // important!
				});

				select.value = "";
				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					if ( value != undefined ) option.value = value;
					else option.value = "HF_"+name.replace(/\s/g, "_");
					return option;
				}

			})();

		</script>

		<script>

		//	Material Tab.

			(function(){

			//	Material manager.

				MaterialManager = {
					matcapSelected: new Signal(),
					currentMaterial: null, // uuid.
				};

				watch( MaterialManager, "currentMaterial", function(prop, action, value){
					debugMode && console.log( prop, action, value );
				});

			})();

			(function(){

			//	Material droplist.

				var currentMaterial = null;

				var tab = TabUI.Materials.tab;
				var row = document.createElement("h3");
				row.textContent = "Material";

				var select = document.createElement("select");
				select.id = "material-droplist";
				select.style.cssText = "width:200px;color:#000;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;";

				select.addItem = function( item ){
					createOption(item.name, item.uuid);
				};

				select.addEventListener("change", function(){
					MaterialManager.currentMaterial = this.value; // uuid.
				});

				row.appendChild( select );
				tab.appendChild( row );
				
				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					option.value = value;
					select.appendChild( option );
				}

			})();

/*
				select.getItemByName = select.getMaterialByName = function( name ){
					return materials.find(function( item ){
						return item.name == name;
					});
				};
				select.getItemByUUID = select.getMaterialByUUID = function( uuid ){
					return materials.find(function( item ){
						return item.uuid == uuid;
					});
				};
				select.getItems = select.getMaterials = function(){
					return materials;
				};
				select.getItem = select.getMaterial = function(){
					return materials.find(function( item ){
						return item.uuid == select.value;
					});
				};
*/

			(function(){

				var textures = {};
				textures.dispose = function(){
					for (var uuid in this ) {
						var texture = this[ uuid ];
						texture.dispose && texture.dispose();
					}
				}

				MaterialManager.matcapSelected.add( function( material ){

					var currentSlot = OutfitManager.currentSlot;
					if ( !currentSlot ) return false; // stop propagination.
					var uuid = OutfitManager.get(currentSlot); // important!
					if ( !uuid ) return false; // stop propagination.

					var mesh = scene.getObjectByProperty("uuid", uuid );
					if ( !mesh ) throw "outfit mesh not found!"; 
					if ( !mesh.visible ) return false; // stop propagination.
					
					if ( Array.isArray( mesh.material ) ) {
						if ( mesh.material.find( function( item ){
							return item.uuid == material.uuid;
						}) == null ) return false;  // stop propagination.
					} else {
						if ( mesh.material.uuid != material.uuid ) return false; // stop propagination.
					}
				});

				MaterialManager.matcapSelected.add( function( material, uuid ){
					if ( !material ) throw "material is null!";
					if ( !material.visible ) return; // important!
					material.roughness = 0;
					material.metalness = 1;
					material.envMap = textures[ uuid ];
					material.envMap.needsUpdate = true;
					material.needsUpdate = true;
					textures.dispose();
				});

				var matcaps = (
					"bixnsMm,MS1GDja,pUytALG,4KwC8wH,Wiqsp9s,gXRFY3U,2tkhy7C,D64zaTR,Id8k2u4,Fx9154f,"
					+ "dqKYFPo,l0Lf1LN,7bH7Ajw,IeAwKEi,VysdwUU,dWAhf12,9ufYr2S,iAWd8i1,mkGDAn5,gf3PsvD,"
					+ "BeHwxKA,GYBQ8Xr,9gxylAS,0p2RT39,aHeUCko,epbmrGs,NKMFDGB,pvXMCj9,QbZ8H2v,aCAVXQb,"
					+ "qU0AEUM,yvwt1wj,D5UeFcC,6GZMeko,rSlm3oM,Xqg7n0A,PzHZLHy,MEzwCJq,wgf7Vl0,GcLQiey,"
					+ "3xH34nj,vhdhgMe,jRTIv3l,xELCxlQ,wtJaViy,Qb0qKtc,7kq8wQ3,F6kcile,0LRxFql,rxUXS8C,"
					+ "qXg0NKn,LSB7hqR,EolEkFt,gOtyiMy,YTE0R32,thsIYPF,ee6stBn,gyYhQao,QOEE3jO,0V4rQPV,"
					+ "l9Tugo0,R86xHzg,IDlk0H9,tUparH7,GISkhjO,JQzRceW,Jl6XqD0,4tyRlwP,aFIJ3Iu,BCqRnS4,"
					+ "1OcGlAa,PqIxyYE,S7J95Cf,QPUvzXD,Stdy1eT,k0nOt5N,rWuDYYe,SGRUmyD,1Ia4Qbk,FFYLtQa,"
					+ "szmc38X,NJSPJlS,8HsVNJA,n3wbE5E,88autaS,7jwTUiI,H1F3Yrv,kgV7aSY,PDFIrWw,Uun8Lpr,"
					+ "Oz16d2L,02gRNwL,bV94g46,eUEtBHC,e1N7JYN,bWpofvm,uzlo3mR,YaXveL2,mw2f1lF,HkWGQb1,"
					+ "N9xoehs,53rWmmo,sBPySdS,1YZKblR,ywKHb7r,3UcbBN7,pWPtSJS,n1a2nB8,lecZa2Q,e3bxY9I,"
					+ "WxVSuFW," // normal matcap.
				).split(",")

				matcaps.pop(); // removes last empty item. (important!)

				var tab = TabUI.Materials.tab;
				var container = document.createElement("div");
				container.id = "matcap-buttons";
				container.style.cssText = "width:101%;max-height:550px;overflow-y:auto;";

				while ( matcaps.length ) {
					(function( id ){

						var button = document.createElement("div");
						button.id = id;
						button.classList.add("btn", "btn-white-outline", "btn-matcap");
						button.style.cssText = "background-size:contain;background-image:url(https://i.imgur.com/"+id+"s.png);";
					//
						var url = "https://i.imgur.com/"+id+".png";   // TODO: cache matcaps.
						var loader = new THREE.ImageLoader();
						loader.setCrossOrigin("anonymous");						// important!
						loader.load( url, function( image ){
							var mapping = THREE.SphericalReflectionMapping;		// important!
							var texture = new THREE.Texture( image, mapping );	// important!
							texture.sourceFile = url;							// important!
							textures[ texture.uuid ] = texture;
							button.setAttribute("uuid", texture.uuid);
							container.appendChild( button );
						});

						button.addEventListener( "click", function(){
							var select = document.getElementById("material-droplist");
							if ( !select ) throw "material-droplist not found!";
							if ( !select.value ) return; // important!
							var material = MaterialManager.getByUUID( select.value );
							if ( !material ) throw "material not found!";
							var uuid = button.getAttribute("uuid");
							MaterialManager.matcapSelected.dispatch( material, uuid );
						});

					})( matcaps.shift() );

				}

				tab.appendChild( container );

			})();

		//	Material Manager.

			(function(){

				var material;
				var materials = [];

				var tab = TabUI.Materials.tab;
				var row = document.createElement("h3");
				row.textContent = "Manager";
				row.title = "Material Manager";

				var Signal = signals.Signal;
			//	materialSelected = new Signal();

				var select = document.createElement("select");
				select.id = "material-manager";
				select.style.cssText = "width:180px;color:#000;" // float:left;
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				select.addEventListener("change", function(){
					material = MaterialManager.getByUUID( this.value );
				});

				MaterialManager.addItem = 
				MaterialManager.addMaterial = 
				MaterialManager.add = function( item ){
					materials.push( item );
					createOption(item.name, item.uuid);
				};

				MaterialManager.getItemByName = 
				MaterialManager.getMaterialByName = 
				MaterialManager.getByName = function( name ){
					return materials.find(function( item ){
						return item.name == name;
					});
				};

				MaterialManager.getItemByUUID = 
				MaterialManager.getMaterialByUUID = 
				MaterialManager.getByUUID = function( uuid ){
					return materials.find(function( item ){
						return item.uuid == uuid;
					});
				};

				MaterialManager.getItems = 
				MaterialManager.getMaterials = function(){
					return materials;
				};

				MaterialManager.getItem = 
				MaterialManager.getMaterial = 
				MaterialManager.get = function(){
					return materials.find(function( item ){
						return item.uuid == select.value;
					});
				};

				row.appendChild( select );
				tab.appendChild( row );
				
				function createOption(name, value){
					var option = document.createElement("option");
					option.text = name;
					option.value = value;
					select.appendChild( option );
				}

			})();

		//	Show/Hide button.

			(function(){

				var tab = TabUI.Materials.tab;
				var row = document.createElement("h3");
				row.style.cssText = "height:40px;";

				var button = document.createElement("div");
				button.textContent = "Hide Selected";
				button.style.cssText = "height:40px;font-size:large;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				button.update = function( visible ){
					if ( visible ) 
						button.textContent = "Hide Selected";
					else 
						button.textContent = "Show Selected";
				};

				(function( select ){
					if ( !select ) throw "material manager select not found!";
					select.addEventListener( "change", function(){
						var selected = MaterialManager.get();
						if ( !selected ) throw "selected material not found!";
						button.update( selected.visible );
					});
				})( document.getElementById("material-manager") );

				button.addEventListener( "click", function(){
					var select = document.getElementById("material-manager");
					if ( !select ) throw "material manager select not found!";
					var selected = MaterialManager.get(); // material.
					if ( !selected ) throw "selected material not found!";
					selected.visible = !selected.visible;
					button.update( selected.visible );
				});

				row.appendChild( button );
				tab.appendChild( row );
			})();

		</script>

		<script>

		//	Eyes Tab.

			(function(){

				var tab = TabUI.Eyes.tab;

				var row = document.createElement("h3");
				row.textContent = "Eyes";

				var Signal = signals.Signal;
				eyeSelected = new Signal();

				var select = document.createElement("select");
				select.id = "eyes-droplist";
				select.style.cssText = "width:180px;color:#000;" // float:left;
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				row.appendChild( select );
			//	tab.appendChild( row );

			})();

			(function(){

				var textures = {};
				var tab = TabUI.Eyes.tab;
			//	var Signal = signals.Signal;
			//	var matcapSelected = new Signal();

				textures.dispose = function(){
					for (var uuid in this ) {
						var texture = this[ uuid ];
						texture.dispose && texture.dispose();
					}
				}

				var matcaps = (
					"eJKcnE2,cP0cGiD,5V0Z1RY,JVIBbWb,fnCXQ5h,Si5QWl0,pbHb2gF,"
				  + "uOdn2Mb,GPouWSo,VybEXWo,kDySexw,8qtMndS,CoIQWMJ,zHVpCoV,"
				  + "5V0Z1RY,"
				).split(",");

				matcaps.pop(); // removes last empty item. (important!)

				var container = document.createElement("div");
				container.id = "eyes-matcap-buttons";
				container.style.width = "300px";

				while ( matcaps.length ) {
					(function( id ){

						var button = document.createElement("div");
						button.id = id;
						button.classList.add("btn", "btn-white-outline", "btn-matcap");
						button.style.cssText = "background-size:contain;background-image:url(https://i.imgur.com/"+id+"s.png);";
					//
						var url = "https://i.imgur.com/"+id+".png";   // TODO: cache matcaps.
						var loader = new THREE.ImageLoader();
						loader.setCrossOrigin("anonymous");						// important!
						loader.load( url, function( image ){
							var mapping = THREE.SphericalReflectionMapping;		// important!
							var texture = new THREE.Texture( image, mapping );	// important!
							texture.sourceFile = url;							// important!
							textures[ texture.uuid ] = texture;
							button.setAttribute("uuid", texture.uuid);
							container.appendChild( button );
						});
					//
						button.addEventListener( "click", function(){
							var selected = scene.getObjectByName("HF_Nudebody");
							if ( !selected ) throw "nudebody not found!";
							var material = selected.material.find(function( item ){
								return item.name == "HF Eyes";
							});  if ( !material ) throw "material not found!";
							(function( material ){
								var uuid = button.getAttribute("uuid");
								material.roughness = 0;
								material.metalness = 1;
								material.envMap = textures[ uuid ];
								material.envMap.needsUpdate = true;
								material.needsUpdate = true;
							})( material );
							textures.dispose();
						});

					})( matcaps.shift() );

				}

				tab.appendChild( container );

			})();

		</script>

		<script>

		//	Animation tab.

			(function(){

				var animations = [];
				currentAnimation = "Idling";

				var Signal = signals.Signal;
				animationChanged = new Signal();

				var tab = TabUI.Animations.tab;
				var row = document.createElement("h3");
				row.textContent = "Animation";

				var select = document.createElement("select");
				select.id = "animation-droplist";
				select.style.cssText = "width:180px;color:#000;" // float:left;
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;";

				select.appendChild(createOption("Idling"));
				select.appendChild(createOption("FallingIdle"));
				select.appendChild(createOption("JumpingUp"));
				select.appendChild(createOption("MediumRun"));
				select.appendChild(createOption("RunningJump"));
				select.appendChild(createOption("Wobbling"));

				select.addAnimation = function( name, clip ){
					animations.push( clip );
				};
				
				select.unshiftAnimation = function( name, clip ){
					animations.unshift( clip );
				};

				select.getAnimationByName = function( name ){
					return animations.find(function( clip ){
						return clip.name == name;
					});
				};

				select.getAnimationByUUID = function( uuid ){
					return animations.find(function( clip ){
						return clip.uuid == uuid;
					});
				};

				select.getAnimations = function(){
					return animations;
				};

				select.addEventListener( "change", function(){
					currentAnimation = this.value;
					animationChanged.dispatch( this.value );
				});

				row.appendChild( select );
				tab.appendChild( row );

				function createOption(name, value){
					var option = document.createElement("option");
					option.text = option.value = name;
					return option;
				}

			})();

		//	Load animations.

			(function(){

				var filesnames = [
					"Idling.fbx",
					"FallingIdle.fbx",
					"JumpingUp.fbx",
					"MediumRun.fbx",
					"RunningJump.fbx",
					"Wobbling.fbx",
				];

				var animationDroplist = document.getElementById("animation-droplist");

				filesnames.forEach( function( filename ){
					var loader = new THREE.FBXLoader();
					loader.load( escape("/rlc/animations/"+filename), function( group ){
						if ( !( group.animations && group.animations.length ) ) return;

						var clip = group.animations[0];
						clip.name = filename.replace(".fbx", "");

						animationDroplist.addAnimation( clip.name, clip );

					});
				});

			})();

			(function(){

			//	Import Animation.

				var tab = TabUI.Animations.tab;
				var row = document.createElement("div");
				row.style.cssText = "margin:10px 12px;height:35px;text-align:center;";

				var button1 = IdleButton();
				var button2 = ImportAnimationButton();

				row.appendChild( button1 );
				row.appendChild( button2 );
				tab.appendChild( row );

				function IdleButton(){

					var button = document.createElement("div");
					button.id = "idle-animaton";
					button.textContent = "Pause";
					button.style.cssText = "max-width:120px;width:100px;float:left;height:40px;font-size:large;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );
					button.addEventListener( "click", function(){
						if ( animationController.currentMotionName == "idling" ) return;
						animationController.play( "Idling" ); 
					});

					return button;
				}

				function ImportAnimationButton() {

					var button = document.createElement("div");
					button.id = "import-animaton";
					button.textContent = "Import animation";
					button.style.cssText = "min-width:60%;width:180px;float:right;height:40px;font-size:large;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

					var input = document.createElement("input");
					input.type = "file";
					input.style.display = "none";
					input.setAttribute("multiple", "");

					var k = 0; // important!
					input.addEventListener( "change", function(){

						for ( var i = 0; i < input.files.length; i++ ) {
							setTimeout(function( file ){

								var filename = file.name.replace(".fbx", "");
								var extension = file.name.split( "." ).pop().toLowerCase();

								var reader = new FileReader();

								reader.addEventListener( "progress", function ( e ) {
									var size = "(" + Math.floor( e.total / 1000 ).format() + " KB)";
									var progress = Math.floor( ( e.loaded / e.total ) * 100 ) + "%";
									console.log( "Loading", filename, size, progress );
								});

								reader.addEventListener( "load", function ( e ) {

									var data = reader.result;
									var loader = new THREE.FBXLoader();
									var group = loader.parse( data );
									group.name = filename;
									console.log( group );

								//	fbx = group; // debug!

								//	Add animations.
									console.log( group.animations );

									if ( group.animations.length ) {
										var name = filename;
										var mixer = animationController.mixer;
										var object = animationController.object;
										var animations = group.animations;
										var select = document.getElementById("animation-droplist");
										animations.forEach( function( clip ){
											animationController.motion[ name ] = mixer.clipAction( clip, object );
											select && select.appendChild( createOption( name ) );
											function createOption(name){
												var option = document.createElement("option");
												option.text = option.value = name;
												return option;
											}
										});
									}

								}, false );
								reader.readAsArrayBuffer( file );

							}, 0, input.files[i] );
						}

					});

					button.addEventListener( "click", function(){
						
						input.value = "";
						input.click();

					});

					button.appendChild( input );
					return button;

				}

			})();

		</script>

		<script>

		//	Scene.
			scene = new THREE.Scene();

		//	Camera.
			(function(){

				var aspect = (window.innerWidth - 370) / window.innerHeight;
				camera = new THREE.PerspectiveCamera( 50, aspect, 1, 10000 );
				camera.position.set(0, 20, 50);

			})();

		//	Editor Controls.
		//	(function(){
		//		controls = new THREE.EditorControls(camera);
		//		if ( controls && controls instanceof THREE.EditorControls ) {
		//			camera.lookAt(controls.center); // important!
		//		}
		//	})();

		//  Camera Light.
			(function(){

				cameraLight = new THREE.DirectionalLight( 0xdfebff, 0.75 );
				cameraLight.position.set( 0, 500, 300 );
				cameraLight.castShadow = true;
				cameraLight.shadow.mapSize.width  = Math.pow(2, 10); // 2048;
				cameraLight.shadow.mapSize.height = Math.pow(2, 10); // 2048;

				var d = 30;
				cameraLight.shadow.camera.left = - d;
				cameraLight.shadow.camera.right = d;
				cameraLight.shadow.camera.top = d;
				cameraLight.shadow.camera.bottom = - d;
				cameraLight.shadow.camera.far = 10000;

				shadowHelper = new THREE.CameraHelper(cameraLight.shadow.camera);
				shadowHelper.visible = false;

				scene.add( cameraLight, shadowHelper  );

				(function update(){
					requestAnimationFrame( update );
					cameraLight.position.copy( camera.position );
				})();

			})();


		//  Renderer.
			(function(){

				renderer = new THREE.WebGLRenderer({
					alpha: true,  // for transparent rendering set alpha:true, important!
					antialias: true,
					preserveDrawingBuffer: true,
				});

				renderer.gammaInput = true;
				renderer.gammaOutput = true;
				renderer.shadowMap.enabled = true;
				renderer.setClearAlpha( 0 ); // for transparent rendering set clear alpha: 0.
				renderer.setClearColor( 0x000000, 1 ); // for transparent rendering set clear alpha: 0.
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( (window.innerWidth - 370), window.innerHeight );
				renderer.domElement.style.background = "none";  // transparent rendering. important!
				document.body.appendChild( renderer.domElement );

				window.addEventListener("resize", function onWindowResize() {
					renderer.setSize( (window.innerWidth - 370), window.innerHeight );
				});

				window.addEventListener("resize", function onWindowResize() {
					camera.aspect = renderer.domElement.clientWidth / renderer.domElement.clientHeight;
					camera.updateProjectionMatrix();
				});

				mouse = new THREE.Vector2();

				renderer.domElement.addEventListener("mousemove", function(e) {
					mouse.x = ( e.clientX / this.clientWidth ) * 2 - 1;
					mouse.y = - ( e.clientY / this.clientHeight ) * 2 + 1;
				});

				(function render(){
					requestAnimationFrame( render );
					renderer.render( scene, camera );
				})();

			})();


		//	World - Octree.
			(function(){

				world = new MW.World();

				var x = 1500, y = 1500, z = 1500;
				var min = new THREE.Vector3( -x, -y, -z );
				var max = new THREE.Vector3(  x,  y,  z );
				var partition = 7; // nodes: Math.pow( 8, partition )

				octree = new MW.Octree( min, max, partition );
				world.add( octree );

				var clock = new THREE.Clock();

				(function update(){
					requestAnimationFrame( update );
					var delta = clock.getDelta();
					var elapsed = clock.getElapsedTime();
					world.step( Math.min( delta, 0.02 ) );
				})();

			})();

		//	ground.js

			(function(){

				var ground = new THREE.Mesh(
					new THREE.PlaneGeometry( 3000, 3000, 1, 1 ).rotateX(-Math.PI/2),
					new THREE.MeshLambertMaterial({ 
						opacity:1, 
						color:0x829ec4,
					})
				);
				
				ground.position.y = 0.3;

			//	We need only the geometry of the ground
			//	so there is not need to add to the scene.
			//	ground.rotation.x = -Math.PI / 2; // THREE.Math.degToRad( -90 );
				octree.importThreeMesh( ground ); // important!
			//	scene.add( ground ); // optional!

			//	Ground Helper.
				groundHelper = new THREE.GridHelper( 3000, 300, 0x444444, 0x444444 );
				scene.add( groundHelper );

			//	Raycaster helper.
				setTimeout(function(){
					var raycaster = new THREE.Raycaster();
					var rayhelper = new THREE.Mesh(
						new THREE.CircleBufferGeometry( 2, 32 ).rotateX(-Math.PI/2),
						new THREE.MeshBasicMaterial( { color:0xffff00, wireframe:false} )
					);
					renderer.domElement.addEventListener("mousemove", function(e) {
						camera.updateMatrixWorld();
						raycaster.setFromCamera( mouse, camera );
						var intersects = raycaster.intersectObject( ground );
						if ( !intersects.length ) return;
						rayhelper.position.copy( intersects[0].point );
					});
				//	scene.add( rayhelper );
				});

			})();


		//	localPlayer Controller.

			(function(){

				var playerRadius = 10;

			//	local player.
				localPlayer = new THREE.Object3D();
				localPlayer.position.set( 0, 10, 0 );
				localPlayer.name = "localPlayer";
				scene.add( localPlayer );

			//	Player helper.
				localPlayerHelper = new THREE.Mesh(
					new THREE.SphereGeometry( playerRadius, 8, 6 ),
					new THREE.MeshBasicMaterial( { color: 0xff0000,  wireframe: true} )
				);

				localPlayerHelper.name = "playerhelper";
				localPlayer.add( localPlayerHelper );

			//	Player controller.
				localPlayerController = new MW.CharacterController( localPlayer, playerRadius );
				localPlayerController.movementSpeed = 50;
				localPlayerController.maxSlopeGradient = 0.5
				world.add( localPlayerController ); // important!

			//	CameraLight target.
				cameraLight.target = localPlayer;

			//	Update rotation.
				(function update(){
					requestAnimationFrame( update );
					localPlayer.rotation.y = localPlayerController.direction + Math.PI; // important!
				})();

			})();

			(function(){

			//	Camera controls.

				cameraControls = new MW.TPSCameraControl(
					camera, 			// three.js camera.
					localPlayer,		// tracking object.
					{	
						el: renderer.domElement,
						offset: new THREE.Vector3( 0, 0, 0 ), // eye height.
						radius: 25, // default distance of the character to the camera.
						minRadius: 1,
						maxRadius: 45,
						rigidObjects: [],
					}
				);

			//	keyInputControls.

				keyInputControls = new MW.KeyInputControl();

				keyInputControls.addEventListener( "movekeyon", function () { 
					localPlayerController.isRunning = true; 
				});

				keyInputControls.addEventListener( "movekeyoff", function () { 
					localPlayerController.isRunning = false; 
				});

				keyInputControls.addEventListener( "jumpkeypress", function () { 
					localPlayerController.jump(); 
				});

			// synch with keybord input and camera control input.
				keyInputControls.addEventListener( "movekeychange",  function () {
					var cameraFrontAngle = cameraControls.getFrontAngle();
					var characterFrontAngle = keyInputControls.frontAngle;
					localPlayerController.direction = THREE.Math.degToRad( 360 ) - cameraFrontAngle + characterFrontAngle;
				});
/*
			//	"updated" event is fired by "cameraControls.update()"
				cameraControls.addEventListener( "updated", function () {
				//	it updates character front angle with the camera view.
				//  We want camera independed from character front angle,
				//	so we keep it disactivated. Maybe used somewhere later.
					var cameraFrontAngle = cameraControls.getFrontAngle();
					var characterFrontAngle = keyInputControls.frontAngle;
					localPlayerController.direction = THREE.Math.degToRad( 360 ) - cameraFrontAngle + characterFrontAngle;
				});
*/
				(function update(){
					requestAnimationFrame( update );
					cameraControls.update();
				})();

			})();

		//	joystickControls.

			(function(){

				var joystick1, joystick2;

				var joysticControls1 = document.createElement( "div" );
				joysticControls1.id = "joystick-controls-1";
				joysticControls1.classList.add("joystick-controls");
				document.body.appendChild( joysticControls1 );

				var joysticControls2 = document.createElement( "div" );
				joysticControls2.id = "joystick-controls-2";
				joysticControls2.classList.add("joystick-controls");
				document.body.appendChild( joysticControls2 );

				var joystick1Selector  = "#joystick1";
				var joystick2Selector  = "#joystick2";
				var jumpButtonSelector = "#jumpButton";

				var joystickControlsSelector  = ".joystick-controls";
				var joystickControls1Selector = "#joystick-controls-1";
				var joystickControls2Selector = "#joystick-controls-2";

				joystick1  = new virtualInput.Joystick( $( joystickControls1Selector ), 94, { id: "joystick1" } );
				joystick2  = new virtualInput.Joystick( $( joystickControls2Selector ), 94, { id: "joystick2" } );
				jumpButton = new virtualInput.Button(   $( joystickControls1Selector ), 58, { id: "jumpButton", label: "<b>JUMP</b>" } ); // buttonSvgSrc

				joystick1.addEventListener( "active", function onActive() { 

					if (  localPlayerController.isJumping 
						|| !localPlayerController.isGrounded 
						|| localPlayerController.isOnSlope ) {
						return;
					}

					localPlayerController.isRunning = true;

				});

				joystick1.addEventListener( "disactive", function onDisactive() { 

					if (  localPlayerController.isJumping 
						|| !localPlayerController.isGrounded 
						||  localPlayerController.isOnSlope ) {
						return;
					}

					localPlayerController.isRunning = false;

				});

				jumpButton.addEventListener( "press", function onPress() { 

					if (  localPlayerController.isJumping 
						|| !localPlayerController.isGrounded 
						|| localPlayerController.isOnSlope ) {
						return;
					}

					localPlayerController.jump();

				});

				joystick1.update = function(){

					if ( this.isActive ) {

						localPlayerController.direction = (3 * Math.PI/2) - cameraControls.getFrontAngle() + this.angle;

					}
				};

				joystick2.update = function(){

					if ( this.isActive ) {

						cameraControls.setLatLon(
							cameraControls.lat + this.position.y * 0.5, // deg.
							cameraControls.lon - this.position.x        // deg.
						);

					}
				};


				(function update(){
					requestAnimationFrame( update );
					joystick1.update();
					joystick2.update();
				})();
				
			})();

		</script>

		<script>

		//	Avatar loader.

		//	var Signal = signals.Signal;
		//	var url = "/rlc/characters/HFStandingIdle02.fbx";
		//	var url = "/rlc/characters/HFStandingIdle01.fbx";

			var loader = new THREE.FBXLoader();
			loader.load( "/rlc/designerkit/2011/RLC_FemaleRigged_2011v2.fbx", function( fbx ){

			//	fbx is THREE.Group.
				var group = fbx; 
				group.name = "RLC Female Body";

				outfits = group.children.filter(function(item){
					return item.isSkinnedMesh;
				}); debugMode && console.log( outfits );

				debugMode && console.log( 
					outfits.map(function(item){return item.name;})
				);

			//	group.position.y = -localPlayerController.radius;
				var s = 0.00033; group.scale.set(s,s,s); // important!
				debugMode && console.log( group );

				group.traverse( function( child ){

                    if (child.isMesh) {	
                        child.castShadow = true;	
                        child.receiveShadow = true;	
                    }

				//	Replace materials.
                    if (child.isMesh) (function(child){
					//	var select = document.getElementById("material-manager");

						if ( Array.isArray(child.material) ) {
							child.material = child.material.map( function( item ){
								var name = item.name;
								return new THREE.MeshStandardMaterial({
									name:name, skinning:true, // important!
								});
							});
							child.material.forEach( function( material ){
								MaterialManager.addItem( material );
							});

						} else {

							var name = child.material.name;
							child.material = new THREE.MeshStandardMaterial({
								name:name, skinning:true, // important!
							});
							(function( material ){
								MaterialManager.addItem( material );
							})( child.material );

						}

					//	debugMode && console.log( child.material );
                    })( child );


				//	Set option values.

                    if (child.isMesh) (function(child){

						var selector = "option[value="+child.name+"]";
						var element = document.querySelector(selector);
						if ( element ) element.value = child.uuid;

                    })( child );


				//	Init female outfit.

                    if (child.isMesh) (function(child){

						var select = document.getElementById("outfit-droplist");
						switch( child.name ){

							case "HF_Nudebody":
								child.visible = true;
								OutfitManager.addItem("body", child.uuid);
							break;

							case "HF_Hair_Med":
								child.visible = true;
								OutfitManager.addItem("hair", child.uuid);
								OutfitManager.currentSlot = "hair"; // important!

								if ( Array.isArray(child.material) ) child.material.forEach(function( material ){
									document.getElementById("material-droplist").addItem( material );
								});

								else (function( material ){
									document.getElementById("material-droplist").addItem( material );
								})( child.material );

								document.getElementById("hat-droplist").value = "";
								document.getElementById("hair-droplist").value = child.uuid;
							break;

							case "HF_Tanktop":
								child.visible = true;
								OutfitManager.addItem("torso", child.uuid);
								document.getElementById("upperbody-droplist").value = child.uuid;
							break;

							case "HF_Frilly_Skirt":
								child.visible = true;
								OutfitManager.addItem("legs", child.uuid);
								document.getElementById("lowerbody-droplist").value = child.uuid;
							break;

							case "HF_Shoes_07":
								child.visible = true;
								OutfitManager.addItem("shoes", child.uuid);
								document.getElementById("shoes-droplist").value = child.uuid;
							break;
								
							default:
								child.visible = false;
							break;
						}

                    })( child );
			//
				});

			/*
				(function(){
					var url = "https://i.imgur.com/7jwTUiI.png";
					var loader = new THREE.ImageLoader();
					loader.setCrossOrigin("anonymous");						// important!
					loader.load( url, function( image ){
						var mapping = THREE.SphericalReflectionMapping;		// important!
						var texture = new THREE.Texture( image, mapping );	// important!
						for ( var i = 0; i < group.getObjectByName("HF_Fullbody_Nude").material.length; i++ ){
							var material = group.getObjectByName("HF_Fullbody_Nude").material[i];
							material.roughness = 0; material.metalness = 1; material.envMap = texture;
							material.envMap.needsUpdate = true; material.needsUpdate = true;
						}
					});
				})();
			*/

			//	Add group to scene before animation controller.
				localPlayerHelper.visible = false;
				localPlayerController.direction += Math.PI; // important!

			//	Update rotation.
				(function update(){
					requestAnimationFrame( update );
					group.rotation.y = localPlayerController.direction + Math.PI; // important!
				})();

			//	Update position.
				(function update(){
					requestAnimationFrame( update );
					group.position.set( 
						localPlayerController.center.x, 
						localPlayerController.center.y - localPlayerController.radius, // -l0
						localPlayerController.center.z 
					);
				})();


			//	Animation controller.

				(function(){

					animationController = new MW.AnimationController( group );

				//	Bind events.
					localPlayerController.addEventListener( "startIdling",  function () { 
						animationController.play( "Idling" ); 
					});

					localPlayerController.addEventListener( "startWalking",  function () { 
						animationController.play( "MediumRun" ); 

					});

					localPlayerController.addEventListener( "startSliding", function () { 
						animationController.play( "Wobbling" ); 
					});

					localPlayerController.addEventListener( "startFalling", function () { 
						animationController.play( "Wobbling" ); 
					});

					localPlayerController.addEventListener( "startJumping",  function () { 
						if ( localPlayerController.isRunning ) {
						//	animationController.motion.RunningJump.setDuration(1.0);
							animationController.motion.RunningJump.reset();
							animationController.play( "RunningJump" ); 
						} else {
						//	animationController.motion.FallingIdle.reset();
							animationController.play( "FallingIdle" ); 
						}
					});

				//	Animation droplist.

					(function(){

						var select = document.getElementById("animation-droplist");

					//	bind animations.
					//	[ "Idling", "FallingIdle", "JumpingUp", "MediumRun","RunningJump", "Wobbling" ]

						select.getAnimations().forEach(function( clip ){

							var mixer = animationController.mixer;
							var object = animationController.object;
							animationController.motion[ clip.name ] = mixer.clipAction( clip, object );

						});

						select.addEventListener("change", function(){
							var name = select.value;
							animationController.play( name );
							if ( animationController.motion[name].clampWhenFinished ) {
								animationController.motion[ name ].reset();
							}
						});

						watch( animationController, "currentMotionName", function(prop, action, value){
							select.value = value; // debugMode && console.log( prop, action, value );
						});

					//	Unshift "Idling" to animations. important!
					//	select.unshiftAnimation( "Idling", group.animations[0] ); // important!

					})();

					function createOption(name){
						var option = document.createElement("option");
						option.text = option.value = name;
						return option;
					}

				//	Animation controller update.
					var clock = new THREE.Clock();

					(function update(){
						requestAnimationFrame( update );
						var delta = clock.getDelta();
						animationController.update( delta );
					})();

					debugMode && console.log( animationController ); 
					localPlayerController.dispatchEvent( {type:"startIdling"} );

				})();

				scene.add( group );

			//	Skeleton helper.

				(function(){
					var armature = group.getObjectByName("Armature");
					skeletonHelper = new THREE.SkeletonHelper(armature);
					skeletonHelper.visible = false;
					scene.add( skeletonHelper );
				})();

			//	Update outfit droplists.

				setTimeout( function(){ OutfitManager.update.dispatch(); });

			}, 

			function onProgress( e ){
				var size = "(" + Math.floor( e.total / 1000 ).format() + " KB)";
				var progress = Math.floor( ( e.loaded / e.total ) * 100 ) + "%";
				console.log( "Loaded", progress, "of", size,  );
			},

			function onError( err ){
				console.error(err);
			});

		</script>

		<script>
			
		//	Snapshots tab.
			
			(function(){

				var tab = TabUI.Snapshots.tab;

				var viewer = document.createElement("div");
				viewer.style.cssText = "width:100%;height:300px;text-align:center;margin-bottom:20px;";
				tab.appendChild( viewer );

			//	var image = new Image(300, 300);
			//	image.id = "snapshot-viewer-img";
			//	image.style.cssText = "width:100%;height:auto;border:1px solid;";
			//	viewer.appendChild(image);
			//	viewer.appendChild( image );

				var row = document.createElement("div");
				row.style.cssText = "margin:10px 15px;height:40px;text-align:center;";

				var button = document.createElement("div");
				button.id = "take-snapshot";
				button.textContent = "Take snapshot";
				button.style.cssText = "min-width:60%;width:fit-content;height:40px;font-size:large;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				button.addEventListener( "click", function onClickHandler(){

				//	Hide ground helper.
					var restoreGroundHelper = false;
					if ( groundHelper && groundHelper.visible ) {
						restoreGroundHelper = true;
						groundHelper.visible = false;
					}

				//	Store clear color, alpha.
					var color = renderer.getClearColor();
					var alpha = renderer.getClearAlpha();

				//	Create result dialog box.
					var dialog = createDialog( 0.5 ); 
					document.body.appendChild( dialog );
				//	debugMode && console.log( dialog );

					function createDialog( scale ){

					//	Render snapshot.
						if ( !scale ) scale = 0.5;
						var width = parseInt( scale * renderer.domElement.width );
						var height = parseInt( scale * renderer.domElement.height );
						renderer.setSize(width, height); 
						renderer.setClearColor( 0x000000, 0 ); // for transparent rendering set clear alpha: 0.
						renderer.render( scene, camera ); // important!
						var dataURL = renderer.domElement.toDataURL("image/png");

					//	Calculate margins.
						function calcMargins(){
						//	var margins = (1-scale) * width / 2;
							var innerWidth = parseInt( window.innerWidth - 370 );
							var margins = parseInt( 0.5 * ( innerWidth - width) );
							var left = margins.toFixed(0)+"px;";
							var right = (margins + 370).toFixed(0)+"px;";
							return "left:"+left+"right:"+right; // +"width:"+width.toFixed(0)+"px;";
						}

						var dialog = document.createElement("div");
						dialog.style.cssText = "display:block;position:fixed;" 
					//	+ "min-height:400px;max-height:600px;height:auto;"
						+ "top:50px;padding:0px;background:#2fa4e7;z-index:100;"
						+ "border:black 2px solid;border-radius:15px;"
						+ "text-align:center !important;" + calcMargins();

						var img = new Image();
						img.id = "snapshot-img";
						img.style.cssText = "width:100%;max-height:540px;height:auto;";
						img.src = dataURL;
						dialog.appendChild( img );

						jcrop = Jcrop.attach( img, {aspectRatio:1} ); 
					//	debugMode && console.log( jcrop );

						var link = document.createElement("a");
						var span = document.createElement("span");
						link.href = dataURL;
						link.text = "click here";
						link.download = "snapshot-image.png";
						link.style.cssText = "color:gold;";
						span.appendChild( link );

						var text = document.createElement("h3");
						text.style.cssText = "position:absolute;bottom:40px;left:20px;right:20px;text-align:left;color:white;";
						text.textContent = "To save image, right click on the image above and select \"Save Image As..\" or alternatively, ";
						text.appendChild( span );
						dialog.appendChild( text );

						var row = document.createElement("div");
						var crop = document.createElement("a");
						crop.text = "Crop";
						crop.style.cssText = "position:absolute;bottom:10px;left:15px;z-index:10;"
						+ "color:white;cursor:pointer;text-decoration:none;font-size:x-large;";

					//	Crop image.
						crop.addEventListener( "click", function(){ 
							if ( !jcrop.active ) { dialog.remove(); return; }

							while ( viewer.children.length ){
								viewer.firstChild.remove(); // debug!
							}

							var canvas = document.createElement( "canvas" );
							canvas.style.cssText = "height:100%;border:1px solid;";

							canvas.width = jcrop.active.pos.w;
							canvas.height = jcrop.active.pos.h;

							var x = 0; var y = 0;
							var w = jcrop.active.pos.w;
							var h = jcrop.active.pos.h;
							var sourceX = jcrop.active.pos.x;
							var sourceY = jcrop.active.pos.y;
							var sourceW = jcrop.active.pos.w;
							var sourceH = jcrop.active.pos.h;

							var ctx = canvas.getContext("2d");
							ctx.drawImage(img, sourceX, sourceY, sourceW, sourceH, x, y, w, h );
							dataURL = canvas.toDataURL("image/png"); link.href = dataURL;
						//	document.getElementById("snapshot-viewer-img").src = dataURL;

							viewer.appendChild( canvas );
							
							dialog.remove();
						//	jcrop.destroy(); 
						});

						var close = document.createElement("a");
						close.text = "Close";
						close.style.cssText = "position:absolute;bottom:10px;right:15px;z-index:10;"
						+ "color:white;cursor:pointer;text-decoration:none;font-size:x-large;";
						close.addEventListener( "click", function(){ dialog.remove(); });

						row.appendChild( crop );
						row.appendChild( close );
						dialog.appendChild( row );

						return dialog;
					}


				//	Restore.
					renderer.setClearColor( color, alpha );
					renderer.setSize( (window.innerWidth - 370), window.innerHeight );
					renderer.render( scene, camera ); // important!
					if (groundHelper) groundHelper.visible = restoreGroundHelper;

				});

				row.appendChild( button );
				tab.appendChild( row );

			})();

		</script>

		<script>

/*
			<input type="number" id="result-img-size-x" value="1400" name="img-size-x" min="200" max="10000">
			<button class="btn btn-success btn-lg" onclick="renderImage();">
				 Generate Image!
			</button>

		//	result image div.

			<div id="result-img-div" style="display: none;position: fixed;left: 50%;margin-left: -400px;width: 800px;
			height: 800px;top: 50px;padding: 10px;background: #2fa4e7;border: black 2px solid;border-radius: 15px;">

				<img id="result-img" style="display:block; width:100%; height: auto;">
				<h2 style="color:white">To save image, right click on the image above and select "Save Image As..", or alternatively, 
					<a id="save-img-link" download="image.png" style="color: yellow">click here</a>.
				</h2>
				<h4 style="color:#ddd">You may use the result image for any personal and / or commercial purpose. No attribution required (although appreciated).</h4>
				<h3>
					<a style="position: absolute;bottom: 10px;left: 15px;color: yellow;cursor: pointer;"
					onclick="document.getElementById('result-img-div').style.display='none';">Close Window</a>
				</h3>

			</div>
*/
/*
		// render canvas!
			function renderImage(){
				var width = parseInt( document.getElementById("result-img-size-x").value );
				var height = width * 1000 / 1400;
				renderer.setSize(width, height);
				render();
				var canvas = renderer.domElement;
				var img_data = canvas.toDataURL("image/png");
				document.getElementById("result-img-div").style.display = "block";
				document.getElementById("result-img").src = img_data;
				document.getElementById("save-img-link").href = img_data;
				onResize();
				render();
			}
*/

		</script>

		<script>

		//	Debug tab.

			(function(){

				var interval;
				var playerObject;
				var k = 0; // important!
				var tab = TabUI.Debug.tab;

			//	Import Remote Player.

				(function(){
					var row = document.createElement("div");
					var playersButton = importPlayersButton();
					row.style.cssText = "margin:10px 15px;height:35px;text-align:center;";
					row.appendChild( playersButton );
					tab.appendChild( row );
				})();

				(function(){
					var row = document.createElement("div");
					var playersButton = addMorePlayersButton();
					row.style.cssText = "margin:10px 15px;height:35px;text-align:center;";
					row.appendChild( playersButton );
					tab.appendChild( row );
				})();

				function addMorePlayersButton() {

					var button = document.createElement("div");
					button.id = "add-player";
					button.textContent = "Add players";
					button.style.cssText = "min-width:60%;width:fit-content;height:40px;font-size:large;text-overflow:ellipsis;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );
					button.addEventListener( "click", function onClickHandler(){

						var url = "/manny/characters/MannyJogging.fbx";
						var loader = new THREE.FBXLoader();
						loader.load( url, function( group ){

							++k; // important!
						//	group is THREE.Group.
							group.name = "MannyJogging";
							var s = 0.00033; group.scale.set(s,s,s); // important!
							debugMode && console.log( group ); 

						//	Replace materials.
							group.children.forEach( function( child ){

								if ( child.type !== "SkinnedMesh" ) return;

								if ( Array.isArray(child.material) ) {
									child.material = child.material.map( function( item ){
										var name = item.name;
										return new THREE.MeshStandardMaterial({
											name:name, skinning:true, // important!
										});
									});

								} else {

									var name = child.material.name;
									child.material = new THREE.MeshStandardMaterial({
										name:name, skinning:true, // important!
									});

								}

								debugMode && console.log( child.material ); 
							});


						//	New player.
							var radius = 10; // player radius.
							var player = new THREE.Object3D();
							player.name = "player_"+k;
							group.position.y = -radius;
							player.add( group );

						//	Random position.
							var r = 25, p = Math.random();
							player.position.set(
								localPlayer.position.x + Math.floor( Math.sin( p * 2*Math.PI ) * r ), // random x,
								radius, // player radius (y),
								localPlayer.position.z + Math.floor( Math.cos( p * 2*Math.PI ) * r )  // random z,
							);

						//	Player helper.
							var playerHelper = new THREE.Mesh(
								new THREE.TetrahedronGeometry(radius, 1),
								new THREE.MeshBasicMaterial({ color:0xffff00, wireframe:true })
							);
							player.add( playerHelper );
							playerHelper.visible = false;
							playerHelper.name = "playerhelper_"+k;

						//	Player controller.
							var playerController = new MW.CharacterController( player, radius );
							playerController.movementSpeed = 40;
							world.add( playerController ); // important!
						//	cameraControls.trackObject = player; // debug!

						//	Player controller random direction.
							playerController.direction = randomDirection();
							player.rotation.y = playerController.direction + Math.PI; // important!
							function randomDirection(){
								return 2 * Math.PI * Math.sin( 2 * Math.PI * Math.random() ); // -3.14 < number > 3.14!
							}

						//	Update rotation.
							(function update(){
								requestAnimationFrame( update );
								player.rotation.y = playerController.direction + Math.PI;
								if ( playerController.center.y < -radius ) {
									playerController.center.set( 0, radius, 0 );
								}
							})();

						//	Animation controller.
							var animationController = new MW.AnimationController( group );
							animationController.play( Object.keys( animationController.motion )[0] );

						//	Update animations.
							var clock = new THREE.Clock();
							(function update(){
								requestAnimationFrame( update );
								var delta = clock.getDelta();
								animationController.update( delta );
							})();

							setTimeout(function(){
								var requestAnimationFrameID;
								crazyIvan( playerController );
								playerController.isRunning = true;
							});

							scene.add( player );
							button.addEventListener( "click", onClickHandler );

						},  function(e){}, function(err){ 
							button.addEventListener( "click", onClickHandler );
						});

						button.removeEventListener( "click", onClickHandler );
					});

					return button;
				}

				function importPlayersButton() {

					var button = document.createElement("div");
					button.id = "import-player";
					button.textContent = "Import players";
					button.style.cssText = "min-width:60%;width:fit-content;height:40px;font-size:large;text-overflow:ellipsis;";
					button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

					var input = document.createElement("input");
					input.type = "file";
					input.style.display = "none";
					input.setAttribute("multiple", "");

				//	var k = 0; // important!
					input.addEventListener( "change", function(){
						debugMode && console.log( input.files );
						for ( var i = 0; i < input.files.length; i++ ){

							(function( file ){

								var filename = file.name;
								var extension = file.name.split( "." ).pop().toLowerCase();

								var reader = new FileReader();

								reader.addEventListener( "progress", function ( e ) {
									var size = "(" + Math.floor( e.total / 1000 ).format() + " KB)";
									var progress = Math.floor( ( e.loaded / e.total ) * 100 ) + "%";
									console.log( "Loading", filename, size, progress );
								});

								reader.addEventListener( "load", function ( e ) {

									var data = reader.result;
									var loader = new THREE.FBXLoader();
									var group = loader.parse( data );
									group.name = filename;

									++k;
								//	New player.
									var radius = 10; // player radius.
									var player = new THREE.Object3D();
									player.name = "player_"+k;

								//	Random position.
									var r = 100; var p = Math.random();
									player.position.set(
										localPlayer.position.x + Math.floor( Math.sin( p * 2*Math.PI ) * r ), // random x,
										radius,	// player radius (y),
										localPlayer.position.z + Math.floor( Math.cos( p * 2*Math.PI ) * r ), // random z,
									);

								//	Player helper.
									var playerHelper = new THREE.Mesh(
										new THREE.TetrahedronGeometry(10, 1),
										new THREE.MeshBasicMaterial({ 
											color: 0xffff00,  
											wireframe: true,
										})
									);

									playerHelper.name = "playerhelper_"+k;
									if ( group.children.find( function( item ){
										return item.type == "SkinnedMesh";
									}) ) playerHelper.visible = false;

									player.add( playerHelper );

								//	Remote player controller.
									var playerController = new MW.CharacterController( player, radius );
									playerController.movementSpeed = 40;
									world.add( playerController ); // important!
								//	cameraControls.trackObject = player; // debug!


								//	Player controller random direction.
									playerController.direction = randomDirection();
									player.rotation.y = playerController.direction + Math.PI; // important!
									function randomDirection(){
										return Math.PI * Math.sin( 2 * Math.PI * Math.random() ); // -3.14 < number > 3.14!
									}

								//	Update remote player rotation.
									(function update(){
										requestAnimationFrame( update );
										player.rotation.y = playerController.direction + Math.PI;
										if ( playerController.center.y < -radius ) {
											playerController.center.set( 0, radius, 0 );
										}
									})();

								//	fbx is THREE.Group.
									var s = 0.00033; group.scale.set(s,s,s); // important!
									group.position.y = -playerController.radius;
									debugMode && console.log( group ); 

								//	Replace materials.
									group.children.forEach( function( child ){
										if ( child.type !== "SkinnedMesh" ) return;
										if ( Array.isArray(child.material) ) {
											child.material = child.material.map( function( item ){
												var name = item.name;
												return new THREE.MeshStandardMaterial({
													name:name, skinning:true,
												});
											});
										} else {
											var name = child.material.name;
											child.material = new THREE.MeshStandardMaterial({
												name:name, skinning:true,
											});
										}
									});

								//	Add group to scene (before animation controller).
									player.add( group );

								//	Animation controller.
									if ( group.animations.length ) {

										var animationController = new MW.AnimationController( group );
										debugMode && console.log( "animations:", Object.keys( animationController.motion ).join() );
										animationController.play( Object.keys( animationController.motion )[0] );

									//	Update animations.
										var clock = new THREE.Clock();
										(function update(){
											requestAnimationFrame( update );
											var delta = clock.getDelta();
											animationController.update( delta );
										})();
									}

									setTimeout(function(){
										var requestAnimationFrameID;
										crazyIvan( playerController );
										playerController.isRunning = true;
									});
									
									scene.add( player );

								}, false );
								reader.readAsArrayBuffer( file );

							})( input.files[i] );

						}
					});

					button.addEventListener( "click", function(){
						
						input.value = "";
						input.click();

					});

					button.appendChild( input );
					return button;

				}

				function crazyIvan( playerController, requestAnimationFrameID ){

				//	from "The Hunt For Red October" movie.
					var max = Math.PI;
					var limit = THREE.Math.degToRad( 1 );
					var direction = ( playerController.direction + randomDirection() ) % max;
					var deltaAngle = ( direction - playerController.direction );
					//	debugMode && console.log( "crazyIvan to:", direction ); // debug!

					cancelAnimationFrame( requestAnimationFrameID ); // important!

					if ( deltaAngle == 0 || isNaN( deltaAngle ) || isNaN( direction ) ) {
						cancelAnimationFrame( requestAnimationFrameID );
						debugMode && console.log( "something isNaN:", deltaAngle );
						setTimeout( crazyIvan, Math.floor( Math.random() * 10000 ), playerController, requestAnimationFrameID );
						return;
					}

					var clock = new THREE.Clock(); // important!

					(function turn(){

						requestAnimationFrameID = requestAnimationFrame( turn );

						var dt = clock.getDelta();

						if ( direction > 0 && playerController.direction > 0
							&& playerController.direction < direction + limit
							&& playerController.direction > direction - limit 
						   ) {
							playerController.direction = direction % max;
							cancelAnimationFrame( requestAnimationFrameID );
							setTimeout( crazyIvan, Math.floor( Math.random() * 10000 ), playerController, requestAnimationFrameID );
							//	debugMode && console.log( playerController.direction ); // debug!
							return;
						}

						if ( direction < 0 && playerController.direction < 0
							&& playerController.direction > direction - limit
							&& playerController.direction < direction + limit 
						   ) {
							playerController.direction = direction % max;
							cancelAnimationFrame( requestAnimationFrameID );
							setTimeout( crazyIvan, Math.floor( Math.random() * 10000 ), playerController, requestAnimationFrameID );
							//	debugMode && console.log( playerController.direction ); // debug!
							return;
						}

						if ( playerController.direction > 2*max ) {
							//
							debugMode && console.log( "crazyIvan direction:", direction ); // debug!
							debugMode && console.log( "crazyIvan +overflow:", playerController.direction ); // debug!
							debugMode && console.log("");
							//
							playerController.direction = 0;
							cancelAnimationFrame( requestAnimationFrameID );
							setTimeout( crazyIvan, Math.floor( Math.random() * 10000 ), playerController, requestAnimationFrameID );
							return;
						}

						if ( playerController.direction < -2*max ) {
							//
							debugMode && console.log( "crazyIvan direction:", direction ); // debug!
							debugMode && console.log( "crazyIvan -overflow:", playerController.direction ); // debug!
							debugMode && console.log("");
							//
							playerController.direction = 0;
							cancelAnimationFrame( requestAnimationFrameID );
							setTimeout( crazyIvan, Math.floor( Math.random() * 10000 ), playerController, requestAnimationFrameID );
							return;
						}

						if ( deltaAngle > 0 ) playerController.direction += Math.min( limit, dt );
						if ( deltaAngle < 0 ) playerController.direction -= Math.min( limit, dt );

						//	debugMode && console.log( playerController.direction ); // debug!

					})();

					//	setTimeout( crazyIvan, Math.floor( Math.random() * 10000 ), playerController, requestAnimationFrameID );

					function mod( a, n ) { 
						return ( a % n + n ) % n;  // important!
					} 

					function getDeltaAngle( current, target ) {
						var a = mod( ( current - target ), 2 * Math.PI );
						var b = mod( ( target - current ), 2 * Math.PI );
						return a < b ? -a : b;
					}

					function randomDirection(){
						return Math.PI * Math.sin( 2 * Math.PI * Math.random() ); // -3.14 < number > 3.14!
					}

				}

			})();

			(function(){
				var tab = TabUI.Debug.tab;
				var row = document.createElement("div");
				var button = document.createElement("div");
				button.id = "ground-helper-button";
				button.textContent = "Hide ground";
				button.style.cssText = "min-width:60%;width:fit-content;height:40px;font-size:large;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				button.addEventListener( "click", function onClickHandler(){
					groundHelper.visible = !groundHelper.visible;
					if ( groundHelper.visible ) 
						button.textContent = "Hide ground";
					else
						button.textContent = "Show ground";
				});
				row.style.cssText = "margin:10px 15px;height:35px;text-align:center;";
				row.appendChild( button );
				tab.appendChild( row );
			})();

		</script>

		<script>
/*

		//	City level.

			(function(){

				var city = {
					block:[],
					streetLights : [],
				};

				var loader = new THREE.GLTFLoader();
				loader.load("/rlc/designerkit/2011/city.gltf",function(gltf){

					model = gltf.scene;

					model.scale.set(0.25,0.25,0.25);
					model.position.x = 500;
					model.position.z = -500;

					model.traverse(function(child){
						if (child.isMesh) {

							child.castShadow = false;
							child.receiveShadow = true;
							child.material = new THREE.MeshLambertMaterial({
								map:child.material.map, side:2,
							})

							if (child.name.includes("Light") && !child.name.includes("BULB")){
								city.streetLights.push(child);
							}

						}
					});

					var box = new THREE.Box3().setFromObject(model);
					debugMode && console.log( box.max, box.min, box.getSize(new THREE.Vector3()) );

					for ( x=-1; x<3; x++){
						for ( y=-1; y<3; y++){
							debugMode && console.log({x,y});

							var clone = model.clone();
							clone.position.z = box.max.z + box.getSize(new THREE.Vector3()).z * x;
							clone.position.x = box.min.x + box.getSize(new THREE.Vector3()).x * -y;
							clone.position.y = 30;

							scene.add(clone); city.block.push(clone);

							clone.traverse(function(child){
								if (child.isMesh) cameraControls.rigidObjects.push(child);
							});

						}
					}

				});

			})();
*/
		</script>

	</body>
</html>
